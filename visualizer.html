<!doctype html>
<head>
	<title>Trello History Visualizer</title>
	<link rel="stylesheet" href="styles.css" type="text/css" media="screen" charset="utf-8">
	<script>
		function loadFile() {
			var input, file, fr;

			if (typeof window.FileReader !== 'function'){
				alert("The file API isn't supported on this browser yet.");
				return;
			}
			input = document.getElementById('fileinput');
			if(!input) {
				alert("Couldn't file fileinput element");
			} else if (!input.files) {
				alert("This browser doesn't support the 'files' property of file inputs.");
			} else if (!input.files[0]) {
				alert("Please select a file before clicking 'Load'");
			} else {
				file = input.files[0];
				fr = new FileReader();
				fr.onload = playHistory;
				fr.readAsText(file);
			}
		}

		function JSONsort(a,b) {
			return (new Date(a['date']).getTime() - new Date(b['date']).getTime());
		}

		function playHistory(e){
			var data = JSON.parse(e.target.result);

			var wrapper = document.getElementById('wrapper');
			wrapper.innerHTML = "";
			var cols = "";
			for (var i = 0; i < data['lists'].length; i++){
				cols += "1fr "
			}
			wrapper.style.gridTemplateColumns = cols;

			var colorMap = {"red":"#F46C54","green":"#A2F554"}

			var columnMap = {};
			for (i in data['lists']){
				columnMap[data['lists'][i]['id']] = 'col-'+i;

				var h = document.createElement('section');
				h.className = 'container col-'+i;
				h.id = data['lists'][i]['id']
				var h3 = document.createElement('h3');
				h3.innerHTML = data['lists'][i]['name'];
				h.appendChild(h3);
				wrapper.appendChild(h);
			}

			var actions = data['actions'];

			actions.sort(JSONsort);

			counter = 0;
			timeout = document.getElementById('timeout').value;
			for (var i = 0; i < actions.length; i++){
				if (actions[i]['type'] == "createCard" || actions[i]['type'] == "updateCard" || actions[i]['type'] == "commentCard") {
					counter++;
					setTimeout(processCard,timeout*counter,actions[i],wrapper,columnMap,colorMap);
					console.log(i);
				}
			}
		}

		function processCard(action,wrapper,columnMap,colorMap) {
			if (action['type'] == "createCard") {
				var card = document.createElement('article');
				card.id = action['data']['card']['id'];
				card.className = 'card';
				card.innerHTML = action['data']['card']['name'];
				document.getElementById(action['data']['list']['id']).appendChild(card);
			}
			else if (action['type'] == 'updateCard') {
				var card = document.getElementById(action['data']['card']['id']);

				if (typeof(action['data']['card']['closed']) == 'undefined'){
					
					if (action['data']['listAfter'] != null) {
						document.getElementById(action['data']['listBefore']['id']).removeChild(card);
						document.getElementById(action['data']['listAfter']['id']).appendChild(card);
					}
					card.innerHTML = action['data']['card']['name'];
				}
				else if (action['data']['card']['closed'] != null && action['data']['card']['closed'] == "true") {
					card.style.display = "none";
				}
			} 
			else if (action['type'] == 'commentCard') {
				var card = document.getElementById(action['data']['card']['id']);
				card.style.borderColor = colorMap[action['data']['text']];
			}
		}
	</script>
</head>
<html>
	Load JSON File&nbsp;<input type='file' id='fileinput'>
	<input type='button' id='btnLoad' value='Load' onclick='loadFile();'>
	&nbsp;&nbsp;&nbsp;&nbsp;Timeout delay (ms)&nbsp;<input id='timeout' type="text" value='750'>
	<div class="wrapper" id="wrapper"></div>
</html>